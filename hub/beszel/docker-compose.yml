services:
  beszel:
    image: henrygd/beszel:0.18.3
    container_name: beszel
    restart: unless-stopped
    volumes:
      - ./data/beszel/data:/beszel_data
      - ./data/beszel/socket:/beszel_socket
    labels:
      - traefik.enable=true
      - traefik.http.routers.beszel.rule=Host(`beszel.${DOMAIN_NAME}`)
      - traefik.http.routers.beszel.entrypoints=websecure
      - traefik.http.routers.beszel.tls=true
      - traefik.http.routers.beszel.tls.certresolver=cloudflare
      - traefik.http.routers.beszel.tls.domains[0].main=beszel.${DOMAIN_NAME}

      # Use the standard headers middleware to ensure HTTPS is passed
      - "traefik.http.routers.beszel.middlewares=beszel-headers"
      - "traefik.http.middlewares.beszel-headers.headers.sslProxyHeaders.X-Forwarded-Proto=https"
      - "traefik.http.middlewares.beszel-headers.headers.browserXssFilter=true"
      # Tell Traefik to pass the original user IP
      - "traefik.http.middlewares.beszel-proxy.headers.forwardedHeadersCustomName=X-Forwarded-For"
      # Force SSE (Realtime) to work through the proxy
      - "traefik.http.middlewares.beszel-proxy.headers.customResponseHeaders.X-Accel-Buffering=no"
      - "traefik.http.routers.beszel.middlewares=beszel-proxy"

      - kuma.beszel.http.url=https://beszel.${DOMAIN_NAME}
    environment:
      - APP_URL=https://beszel.${DOMAIN_NAME}
      - TRUSTED_PROXIES=0.0.0.0/0
      - DISABLE_PASSWORD_AUTH=${DISABLE_PASSWORD_AUTH}
      - USER_CREATION=${USER_CREATION}
      - USER_EMAIL=${USER_EMAIL}
      - USER_PASSWORD=${USER_PASSWORD}
